cluster_name: easydel-us-central2-b

max_workers: 1024

provider:
  type: gcp
  region: us-central2
  availability_zone: us-central2-b
  project_id: caltech-408917

docker:
  image: "ghcr.io/erfanzar/easydel:latest-tpu"
  container_name: "ray_docker"
  pull_before_run: true
  worker_run_options:
    - --privileged
    - --ulimit memlock=-1:-1
    - --shm-size=32gb
    - -e TPU_WORKER_ID
    - -v "/tmp:/tmp"
    - -v "/var/run/docker.sock:/var/run/docker.sock"
  head_run_options:
    - --privileged
    - -v "/tmp:/tmp"
    - --ulimit nofile=1048576:1048576
    - -e RAY_TPU_MAX_CONCURRENT_ACTIVE_CONNECTIONS=64

initialization_commands:
  - gcloud config set project caltech-408917
  - gcloud config set compute/region us-central2
  - gcloud config set compute/zone us-central2-b
  - yes | gcloud auth configure-docker us-central2-docker.pkg.dev
  - "export TPU_WORKER_ID=$(curl -H 'Metadata-Flavor: Google' http://metadata.google.internal/computeMetadata/v1/instance/attributes/agent-worker-number) || true"
  - which docker || (curl -fsSL https://get.docker.com -o get-docker.sh; sudo sh get-docker.sh; sudo usermod -aG docker $USER; sudo systemctl restart docker -f)
  - sudo usermod -aG docker $USER
  - sudo chmod 666 /var/run/docker.sock

head_setup_commands:
  - mkdir $HOME/.cache/huggingface -p
  - gcloud secrets versions access latest --secret=HF_TOKEN > $HOME/.cache/huggingface/token || true

worker_setup_commands:
  - mkdir $HOME/.cache/huggingface -p
  - gcloud secrets versions access latest --secret=HF_TOKEN > $HOME/.cache/huggingface/token || true

head_node_type: head_default

available_node_types:
  head_default:
    min_workers: 0
    max_workers: 0
    resources: { "CPU": 0, "head_node": 1 }

    node_config:
      machineType: n2-standard-8
      disks:
        - boot: true
          autoDelete: true
          type: PERSISTENT
          initializeParams:
            diskSizeGb: 200

            sourceImage: projects/ubuntu-os-cloud/global/images/family/ubuntu-2204-lts
  tpu_base_v4_8:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-8
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-8-head: 1

  tpu_slice_v4_16:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-16
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-16-head: 1

  tpu_slice_v4_32:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-32
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-32-head: 1

  tpu_slice_v4_64:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-64
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-64-head: 1

  tpu_slice_v4_128:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-128
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-128-head: 1

  tpu_slice_v4_256:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-256
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-256-head: 1

  tpu_slice_v4_512:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-512
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-512-head: 1

  tpu_slice_v4_1024:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-1024
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-1024-head: 1

  tpu_slice_v4_2048:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-2048
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-2048-head: 1

  tpu_slice_v4_4096:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v4-4096
      runtimeVersion: tpu-ubuntu2204-base
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v4-4096-head: 1

  tpu_base_v6e_4:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-4
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-4-head: 1

  tpu_slice_v6e_8:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-8
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-8-head: 1

  tpu_slice_v6e_16:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-16
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-16-head: 1

  tpu_slice_v6e_32:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-32
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-32-head: 1

  tpu_slice_v6e_64:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-64
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-64-head: 1

  tpu_slice_v6e_128:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-128
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-128-head: 1

  tpu_slice_v6e_256:
    max_workers: 1024
    min_workers: 0
    node_config:
      acceleratorType: v6e-256
      runtimeVersion: v2-alpha-tpuv6e
      schedulingConfig:
        preemptible: true
    resources:
      CPU: 120
      TPU: 4
      tpu-v6e-256-head: 1
